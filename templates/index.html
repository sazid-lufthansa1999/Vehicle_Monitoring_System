<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Enterprise Monitor</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
</head>

<body class="dark-theme">
    <div class="app-shell">
        <!-- Sidebar Navigation -->
        <nav class="app-nav">
            <div class="logo">
                <span class="icon">üõ∞Ô∏è</span>
                <h2>AI Vision</h2>
            </div>
            <ul class="nav-links">
                <li class="active" onclick="switchView('live')"><span>üìπ</span> Live Monitor</li>
                <li onclick="switchView('archive')"><span>üìÅ</span> Violation Archive</li>
                <li onclick="switchView('logs')"><span>üìã</span> System Logs</li>
                <li onclick="switchView('settings')"><span>‚öôÔ∏è</span> Cam Settings</li>
            </ul>
            <div class="user-profile">
                <div class="user-info">
                    <span class="user-name">{{ user }}</span>
                    <span class="user-role">{{ role }}</span>
                </div>
                <a href="{{ url_for('logout') }}" class="logout-btn">üö™</a>
            </div>
        </nav>

        <!-- Main Content Area -->
        <main class="app-main">
            <!-- HEADER -->
            <header class="top-bar">
                <div id="view-title">Live Monitoring</div>
                <div class="top-stats">
                    <div class="top-stat">IN: <span id="stat-in">0</span></div>
                    <div class="top-stat">OUT: <span id="stat-out">0</span></div>
                    <div class="top-stat alert">VIOLATIONS: <span id="stat-v">0</span></div>
                </div>
            </header>

            <!-- LIVE VIEW -->
            <section id="view-live" class="content-view active">
                <div class="live-grid">
                    <div class="video-wrapper">
                        <img src="{{ url_for('video_feed') }}" id="main-stream">
                        <div class="stream-badge">LIVE</div>
                    </div>
                    <div class="realtime-feed">
                        <h3>Real-time Alerts</h3>
                        <div id="alert-items" class="alert-list"></div>
                    </div>
                </div>
            </section>

            <!-- ARCHIVE VIEW -->
            <section id="view-archive" class="content-view">
                <div class="archive-header">
                    <h2>Historical Citations</h2>
                    <button class="btn-refresh" onclick="loadArchive()">üîÑ Refresh</button>
                </div>
                <div class="archive-grid" id="archive-items">
                    <!-- Cards will be injected here -->
                </div>
            </section>

            <!-- SETTINGS VIEW -->
            <section id="view-settings" class="content-view">
                <h2>Cam Sources & Upload</h2>

                <div class="settings-grid">
                    <div class="settings-card">
                        <h3>Custom Media Upload</h3>
                        <p>Upload a video or image to analyze:</p>
                        <div class="upload-area">
                            <input type="file" id="media-file" name="file" accept="video/*,image/*">
                            <button type="button" class="btn-primary" onclick="handleUpload()">Upload & Analyze</button>
                            <div id="upload-status" class="status-msg"></div>
                        </div>
                    </div>

                    <div class="settings-card">
                        <h3>Preset Cam Sources</h3>
                        <div class="cam-options">
                            <button class="btn-cam" onclick="switchCam('Sazid-vaiya.mp4')">Source 1 (Main Road)</button>
                            <button class="btn-cam" onclick="switchCam('istockphoto-1142262134-640_adpp_is.mp4')">Source
                                2 (Parking)</button>
                            <button class="btn-cam" onclick="switchCam('2103099-uhd_3840_2160_30fps.mp4')">Source 3 (4K
                                Highway)</button>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Video Modal Player -->
    <div id="video-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <video id="archive-player" controls>
                <source src="" type="video/mp4">
            </video>
            <h3 id="modal-title"></h3>
        </div>
    </div>

    <script>
        function switchView(viewId) {
            document.querySelectorAll('.content-view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-links li').forEach(l => l.classList.remove('active'));
            document.getElementById('view-' + viewId).classList.add('active');
            event.target.closest('li').classList.add('active');
            document.getElementById('view-title').innerText = viewId.toUpperCase() + ' MONITOR';

            if (viewId === 'archive') loadArchive();
        }

        async function updateStats() {
            try {
                const res = await fetch('/stats');
                const data = await res.json();
                document.getElementById('stat-in').innerText = data.in_count;
                document.getElementById('stat-out').innerText = data.out_count;
                document.getElementById('stat-v').innerText = data.total_violations;

                const alertContainer = document.getElementById('alert-items');
                alertContainer.innerHTML = '';
                data.recent_violations.reverse().slice(0, 5).forEach(v => {
                    const div = document.createElement('div');
                    div.className = 'alert-row';
                    div.innerHTML = `<strong>${v.type}</strong> <span>ID:${v.tracker_id}</span>`;
                    alertContainer.appendChild(div);
                });
            } catch (e) { }
        }

        async function loadArchive() {
            const container = document.getElementById('archive-items');
            container.innerHTML = '<p>Loading citations...</p>';
            const res = await fetch('/violations');
            const data = await res.json();
            container.innerHTML = '';
            data.forEach(v => {
                const card = document.createElement('div');
                card.className = 'citation-card';
                card.innerHTML = `
                    <div class="card-type">${v.type}</div>
                    <div class="card-info">Vehicle ID: ${v.id}</div>
                    <div class="card-time">${v.time}</div>
                    <button class="btn-play" onclick="playVideo('${v.filename}', '${v.type} - ID:${v.id}')">‚ñ∂ Watch Clip</button>
                `;
                container.appendChild(card);
            });
        }

        function playVideo(filename, title) {
            const modal = document.getElementById('video-modal');
            const player = document.getElementById('archive-player');
            player.src = '/video/violation/' + filename;
            document.getElementById('modal-title').innerText = title;
            modal.style.display = "block";
            player.play();
        }

        function closeModal() {
            document.getElementById('video-modal').style.display = "none";
            document.getElementById('archive-player').pause();
        }

        async function switchCam(source) {
            const res = await fetch('/switch_camera', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ source: source })
            });
            if (res.ok) {
                alert("Switching to " + source + ". Stream will resume shortly.");
                location.reload();
            }
        }

        async function handleUpload() {
            const fileInput = document.getElementById('media-file');
            const status = document.getElementById('upload-status');

            if (fileInput.files.length === 0) {
                status.innerText = "Please select a file first.";
                return;
            }

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);

            status.innerText = "Uploading and preparing AI Analysis...";

            try {
                const res = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();
                if (data.status === "success") {
                    status.innerText = "Analysis started!";
                    setTimeout(() => {
                        switchView('live');
                        location.reload();
                    }, 1500);
                } else {
                    status.innerText = "Upload failed: " + data.message;
                }
            } catch (e) {
                status.innerText = "Error uploading file.";
            }
        }

        setInterval(updateStats, 1000);
    </script>
</body>

</html>